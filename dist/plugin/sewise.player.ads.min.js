/*
 * Name: SewisePlayer ADS plugin
 * Author: keyun
 * Website: http://player.sewise.com
 * Date: January 19, 2016
 * Copyright: 2013-2016, Sewise
 * Mail: keyun@sewise.com
 * - Licensed under the MIT license
 * 
 */

!function(a,b){function c(a,b,c,d){var e={},f=c/a,g=d/b;return f>=g?(e.width=Math.min(a*g,c),e.height=b*g):(e.width=Math.min(a*f,c),e.height=b*f),e.width=Math.ceil(e.width),e.height=Math.ceil(e.height),e.x=Math.round((c-e.width)/2),e.y=Math.round((d-e.height)/2),e}var d=a.SewiseAds=function(){this.player=null,this.adsContainer=null,this.skinContainer=null,this.video=null,this.playerContainer=null,this.cornerAdsEle=null,this.adPlaying=!1,this.endAdsPlay=!1,this.isPlayEndAds=!1,this.imgPlayIndex=0,this.adsCallBack=null,this.noticeOpenAdsLink=!1};d.prototype.init=function(a){if(this.player=a,"flash"===this.player.playController.playerType)this.player.playController.playVars.loadFlashPlugin=!0;else{this.skinContainer=this.player.getSkinContainer(),this.video=this.player.getVideo(),this.adsCallBack=this.player.playController.globalParam.parameObj.adscallback,this.noticeOpenAdsLink=this.player.playController.globalParam.parameObj.noticeOpenAdsLink;var b=JSON.parse(this.player.playController.playVars.adsJSONStr);this.createAds(b)}},d.prototype.createAds=function(a){this.parseData(a)},d.prototype.parseData=function(a){function b(){d.player.off("beforePlay",b),d.player.playController.playVars.autoStart=!1,d.showVideoAds(c.start,"start")}this.playerContainer=this.player.getPlayerContainer();var c=a||{},d=this;if(c.start&&this.player.on("beforePlay",b),c.pause&&this.player.on("pause",function(){d.adPlaying||d.isPlayEndAds||"pause"!=this.player.playController.state||d.showImageAd(c.pause)}),c.corner&&c.corner.length>0&&this.player.on("timeupdate",function(){if(!d.adPlaying){var a=d.getWillShowCornerAds(c.corner);a&&d.showCornerAds(a)}}),c.end&&c.end.length>0){var e=c.end[0].type;this.player.on("ended",function(){d.endAdsPlay||d.adPlaying||(d.isPlayEndAds=!0,"image"===e?(d.showImageAd(c.end,"end"),d.endAdsPlay=!0):d.showVideoAds(c.end,"end"))})}},d.prototype.switchContainer=function(a){return a?(b(this.skinContainer).css("display","none"),void(this.adsContainer=b('<div class="ads" style="position:absolute;left:0px;top:0px;width:100%;height:100%;"><div style="position:absolute;right:5px;bottom:5px;"><a class="detail-link" href="#">详情</a></div></div>').appendTo(this.playerContainer)[0])):(b(this.skinContainer).css("display","block"),null!==this.adsContainer&&b(this.adsContainer).remove(),void(this.adsContainer=null))},d.prototype.showVideoAds=function(a,c){function d(){n++,o-=q.duration,n<a.length?(q=a[n],h.adsReport({data:q,pos:c}),h.player.timeupdateOpen=!1,this.src=q.src,this.play()):(b(this).unbind("ended",arguments.callee),b(this).unbind("onerror",arguments.callee),b(this).unbind("timeupdate",e),b(this).unbind("pause",f),b(m).removeClass("bigPlayBtn"),m.remove(),m=null,h.switchContainer(!1),i.poster=k,i.src=j,h.player.timeupdateOpen=!0,"end"===c?(h.endAdsPlay=!0,i.autoplay=!1):i.play(),h.adPlaying=!1)}function e(){var a=parseInt(o-this.currentTime,10);a=a>0?a:0,l.html(a)}function f(){m&&m.show()}function g(){i.removeEventListener("canplay",g),i.play()}this.switchContainer(!0),c=c||"start";var h=this,i=this.video;i.removeAttribute("autoplay");var j=this.player.playController.playVars.videoUrl;j||(j=this.player.playController.playVars.streamUrl);var k=this.player.playController.playVars.poster,l=b('<div style="position:absolute;right:5px;top:5px;z-index:1000;color:#fff;background:#000">广告:<span class="countdown-box"></span>秒</div>').appendTo(this.adsContainer).find(".countdown-box"),m=b('<div style="position:absolute;width:90px;height:90px;z-index:999;left:50%;top:50%;margin:-45px 0 0 -45px;display:block;"></div>').appendTo(this.adsContainer).end();b(m).addClass("bigPlayBtn");for(var n=0,o=0,p=0;p<a.length;p++)o+=parseInt(a[p].duration);l.html(parseInt(o,10));var q=a[n];this.adsReport({data:q,pos:c}),b(this.adsContainer).find("a.detail-link").click(function(a){a.originalEvent.stopPropagation?a.originalEvent.stopPropagation():a.originalEvent.cancelBubble=!0,self!=top?h.noticeOpenAdsLink?h.player.fireEvent("openAdsLink",q.link):window.parent.window.open(q.link):h.noticeOpenAdsLink?h.player.fireEvent("openAdsLink",q.link):window.open(q.link)}),m.click(function(){i.play(),m.hide()}),b(i).bind({ended:d,onerror:d,pause:f,timeupdate:e}),this.player.timeupdateOpen=!1,i.src=q.src,this.adPlaying=!0,i.autoplay=!0,i.addEventListener("canplay",g),i.addEventListener("playing",function(){m&&m.hide()}),i.load?i.load():i.play()},d.prototype.showImageAd=function(a,d){function e(){var a,b=o.width(),d=o.height();b>m||d>n?(a=c(b,d,m,n),o.width(a.width),o.height(a.height)):(a={width:b,height:d},a.x=Math.round((m-a.width)/2),a.y=Math.round((n-a.height)/2)),k.width(a.width),k.height(a.height),k.css("left",a.x),k.css("top",a.y)}function f(){k&&k.remove(),j.player.off("start",f),k=null}d=d||"pause";var g=a.length,h=this.imgPlayIndex=this.imgPlayIndex>=g?0:this.imgPlayIndex,i=a[h];this.imgPlayIndex++,this.adsReport({data:i,pos:d});var j=this,k=b('<div style="position:absolute;left:0px;top:0px;z-index:10001;"><div class="closeDiv" style="position:absolute;right:5px;top:5px;"><a class="close-btn" style="display:block" href="javascript:void(0);">关闭</a></div><img src="'+i.src+'"/></div>').appendTo(this.playerContainer),l=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);l&&k.find(".closeDiv").css("right","25px");var m=b(this.playerContainer).width(),n=b(this.playerContainer).height();k.find(".close-btn").click(function(a){a.stopImmediatePropagation?a.stopImmediatePropagation():a.originalEvent.cancelBubble=!0,k.remove(),k=null}),k.click(function(a){j.noticeOpenAdsLink?j.player.fireEvent("openAdsLink",i.link):window.open(i.link),a.stopImmediatePropagation?a.stopImmediatePropagation():a.originalEvent.cancelBubble=!0});var o=k.find("img");o.get(0).onload=e,window.onresize=function(){m=b(j.playerContainer).width(),n=b(j.playerContainer).height(),e()},this.player.on("start",f)},d.prototype.getWillShowCornerAds=function(a){for(var b,c,d,e=a.length,f=0;e>f;f++)if(c=this.player.playTime(),b=a[f],c>=b.showTime&&c<=b.showTime+b.duration){d=b,a.splice(f,1);break}return d},d.prototype.showCornerAds=function(a){function c(){var a=j.width(),b=j.height(),c={width:a,height:b};a>h/3&&(c.width=h/3),b>i/3&&(c.height=i/3),c.x=h-c.width-5,c.y=i-c.height-60,j.width(c.width),j.height(c.height),f.width(c.width),f.height(c.height),f.css("left",c.x),f.css("top",c.y)}this.cornerAdsEle&&(this.cornerAdsEle.remove(),this.cornerAdsEle=null),pos="corner";var d=a;this.adsReport({data:d,pos:pos});var e=this,f=b('<div style="position:absolute;left:0px;top:0px;z-index:10002;"><div class="closeDiv" style="position:absolute;right:5px;top:5px;"><a class="close-btn" style="display:block" href="javascript:void(0);">关闭</a></div><img src="'+d.src+'"/></div>').appendTo(this.playerContainer),g=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);g&&f.find(".closeDiv").css("right","25px");var h=b(this.playerContainer).width(),i=b(this.playerContainer).height();this.cornerAdsEle=f,f.find(".close-btn").click(function(a){a.stopImmediatePropagation?a.stopImmediatePropagation():a.originalEvent.cancelBubble=!0,f.remove(),f=null,e.cornerAdsEle=null}),f.click(function(a){e.noticeOpenAdsLink?e.player.fireEvent("openAdsLink",d.link):window.open(d.link),a.stopImmediatePropagation?a.stopImmediatePropagation():a.originalEvent.cancelBubble=!0});var j=f.find("img");j.get(0).onload=c,window.onresize=function(){h=b(e.playerContainer).width(),i=b(e.playerContainer).height(),c()},setTimeout(function(){e.cornerAdsEle&&(e.cornerAdsEle.remove(),e.cornerAdsEle=null)},1e3*d.duration)},d.prototype.adsReport=function(b){this.adsCallBack&&this.adsCallBack.adsPlayCallBack&&a[this.adsCallBack.adsPlayCallBack](b)}}(window,window.jQuery);